{% extends "base.html" %}

{% block title %}Dashboard - Social Media Scheduler{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
{% endblock %}

{% block content %}
    {% if posts %}
    <div class="table-wrapper">
        <table class="posts-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Content</th>
                    <th>Platform</th>
                    <th>Scheduled Time</th>
                    <th>Image</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts %}
                <tr id="post-{{ post.id }}" class="{{ post.status }}" data-scheduled-time="{{ post.scheduled_time.isoformat() }}">
                    <td data-label="Title">{{ post.title }}</td>
                    <td data-label="Content">{{ post.content }}</td>
                    <td data-label="Platform" class="platform-cell">
                        {% set logos = {
                            'instagram': 'logos/instagram.png',
                            'twitter': 'logos/twitter.png',
                            'facebook': 'logos/facebook.png',
                            'linkedin': 'logos/linkedin.png'
                        } %}
                        <img src="{{ url_for('static', filename=logos.get(post.platform.lower(), '')) }}" class="platform-logo" alt="{{ post.platform }}">
                        <span>{{ post.platform }}</span>
                    </td>
                    <td data-label="Scheduled Time">
                        {{ post.scheduled_time.strftime('%b %d, %Y %I:%M %p') }}
                        <span class="countdown"></span>
                    </td>
                    <td data-label="Image">
                        {% if post.image_filename %}
                            <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" class="post-image" alt="Post Image">
                        {% else %}
                            <span class="no-image">-</span>
                        {% endif %}
                    </td>
                    <td data-label="Status" class="status">{{ post.status|capitalize }}</td>
                    <td data-label="Actions">
                        <a href="{{ url_for('edit', id=post.id) }}" class="action-btn edit-btn">‚úèÔ∏è Edit</a>
                        <a href="{{ url_for('delete', id=post.id) }}" class="action-btn delete-btn" onclick="return confirm('Are you sure you want to delete this post? This cannot be undone.')">üóëÔ∏è Delete</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="no-posts">
        <h2>No posts scheduled yet.</h2>
        <p><a href="{{ url_for('schedule') }}">Click here to add your first post!</a></p>
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const socket = io();

        socket.on("status_update", (data) => {
            const row = document.getElementById(`post-${data.post_id}`);
            if (row) {
                const statusCell = row.querySelector(".status");
                statusCell.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                row.className = data.status; // Update row class for styling
                
                // Hide countdown when posted
                const countdownEl = row.querySelector('.countdown');
                if (countdownEl) {
                    countdownEl.style.display = 'none';
                }
            }
        });

        function updateCountdowns() {
            const now = new Date();
            document.querySelectorAll("tr.scheduled").forEach(row => {
                const scheduledTime = new Date(row.dataset.scheduledTime);
                const countdownEl = row.querySelector(".countdown");
                const diff = scheduledTime - now;

                if (diff > 0) {
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    let countdownText = '‚è≥ ';
                    if (days > 0) countdownText += `${days}d `;
                    if (hours > 0 || days > 0) countdownText += `${hours}h `;
                    countdownText += `${minutes}m ${seconds}s`;

                    countdownEl.textContent = countdownText.trim();
                } else {
                    // Once time is reached, the server-side job will take over.
                    // We just update the text to avoid confusion.
                    countdownEl.textContent = "Processing...";
                }
            });
        }

        setInterval(updateCountdowns, 1000);
        updateCountdowns(); // Run immediately on load
    });
</script>
{% endblock %}
